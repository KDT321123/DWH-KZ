import axios, { AxiosResponse } from "axios";
import urljoin from "url-join";
import { getEnvValue } from "../utils/core-utils";
import { ENV_H2O_URL } from "../utils/destinations";
import {
  DevspaceInfo,
  DevspaceApiResults,
  flattenDevspaceInfo,
} from "../utils/devspace-utils";

/**
 * Return information about the current workspace.
 *
 * @returns - devspace information
 */
export async function getDevspaceInfo(): Promise<DevspaceInfo> {
  const devspaceId = getEnvValue("WORKSPACE_ID").replace("workspaces-", "");
  const url = urljoin(
    getEnvValue(ENV_H2O_URL),
    `/ws-manager/api/v1/workspace/${devspaceId}`
  );
  let response: AxiosResponse<DevspaceApiResults>;

  try {
    response = await axios.get(url);
  } catch (error) {
    const errorDetail =
      error instanceof Error ? `Error message: ${error.message}.` : "";
    throw new Error(
      `Couldn't retrieve devspace information from the (${url}) URL. ${errorDetail}`
    );
  }
  const devspaceInfo = flattenDevspaceInfo(response.data);
  return devspaceInfo;
}
